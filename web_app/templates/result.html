<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
    <style type="text/css">
        body {
            white-space: pre;
            font-family: monospace;
        }
        .pure-button {
            margin: 10px;
        }
        pre {
            background-color: ghostwhite;
            border: 1px solid silver;
            padding: 10px 20px;
            margin: 20px;
        }
        .json-key {
            color: brown;
        }
        .json-value {
            color: navy;
        }
        .json-string {
            color: olive;
        }
    </style>
    <title>Results</title>
</head>

<body>
    Your ID: {{ req_id }} Total Emails: {{ length }}
    <input type="button" class="pure-button pure-button-primary" id="delbtn" value="delete all" onclick="del('{{ req_id }}','{{ length }}')" />
    <input type="button" class="pure-button pure-button-primary" id="download" value="download as csv" />

    <div class="inner"></div>
    <pre><code id=json></code></pre>
    <script type="text/javascript">
        var main_data = null;
       

                    if (!library)
                        var library = {};

                    library.json = {
                        replacer: function(match, pIndent, pKey, pVal, pEnd) {
                            var key = '<span class=json-key>';
                            var val = '<span class=json-value>';
                            var str = '<span class=json-string>';
                            var r = pIndent || '';
                            if (pKey)
                                r = r + key + pKey.replace(/[": ]/g, '') + '</span>: ';
                            if (pVal)
                                r = r + (pVal[0] == '"' ? str : val) + pVal + '</span>';
                            return r + (pEnd || '');
                        },
                        prettyPrint: function(obj) {
                            var jsonLine = /^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/mg;
                            return JSON.stringify(obj, null, 3)
                                .replace(/&/g, '&amp;').replace(/\\"/g, '&quot;')
                                .replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                .replace(jsonLine, library.json.replacer);
                        }
                    };




                    var len = "{{ length }}";
                    console.log(len);
                    var req_id = "{{ req_id }}";
                    console.log(req_id);
                    $(".inner").text("Loading ...");

                    function del(id, len) {
                        $.ajax({
                            type: "DELETE",
                            url: "http://spiderapi.herokuapp.com/api/email/" + id + "/",
                            success: function(msg) {
                                alert("Data Deleted: " + JSON.stringify(msg));
                            }
                        });
                        load(id, len);
                    }

                    function download(id, len) {
                        console.log('in load()')
                        alert(" hello !");
                    }

                    var refreshIntervalId = setInterval(() => {
                        console.log("request id: " + req_id + " length: " + len);
                        $.getJSON('http://spiderapi.herokuapp.com/api/email/' + req_id + '/', (data) => {
                            console.log("recieved length: " + data.length);
                            if (data.length < len) {
                                document.getElementsByClassName("inner")[0].innerHTML = "Loading ...<br>Processed till now: <b>" + data.length + "</b>"
                            } else if (data.length >= len) {
                                document.getElementsByClassName("inner")[0].innerText = "";
                                $('#json').html(library.json.prettyPrint(data));
                                main_data = data;
                                clearInterval(refreshIntervalId);
                                console.log('done');
                            }
                        });
                    }, 7000);
    </script>
</body>

</html>